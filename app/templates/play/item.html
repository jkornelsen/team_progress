{% extends 'base.html' %}
{% block upper_left %}
    <div class="nav-container">
        <a class="upper-left" href="{{ url_for("overview") }}">[O]verview</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for("configure_index") }}">[M]ain Setup</a>
        <span class="separator">|</span>
        <a class="upper-left"
           href="{{ url_for('configure_item', item_id=current.id) }}">Item S[e]tup</a>
    </div>
{% endblock %}
{% block content %}
    <div id="content" style="display:none;">
        <script>
        const linkForKey = {
            'o': '{{ url_for('overview') }}',
            'm': '{{ url_for('configure_index') }}',
            'e': '{{ url_for('configure_item', item_id=current.id) }}',
        };
        const funcForKey = {};
        document.addEventListener('DOMContentLoaded', () => {
            if (isMobile) {
                return;
            }
            document.addEventListener('keypress', (event) => {
                const key = event.key.toLowerCase();
                if (key === 'd') {
                    event.preventDefault();
                    $('#drop-btn').click();
                } else if (key === 'p') {
                    event.preventDefault();
                    $('#pickup-btn').click();
                } else if (key === 'q') {
                    event.preventDefault();
                    {% if current.pile.slot %}
                        $('#unequip-btn').click();
                    {% elif game_data.overall.slots %}
                        $('#equip-btn').click();
                    {% endif %}
                } else if (linkForKey[key]) {
                    event.preventDefault();
                    window.location.href = linkForKey[key];
                } else if (funcForKey[key]) {
                    event.preventDefault();
                    funcForKey[key]();
                }
            });
        });
        </script>
        <table style="width: 100%; max-width: 80%; margin: 0 auto;">
            <tr>
                <td>
                    {% if current.pile.container_type() == 'general' %}
                        General Storage
                        <br>
                    {% elif current.pile.container_type() == 'char' %}
                        {% set link = url_for('play_char', char_id=container.id) %}
                        {% set letter = link_letters.next(link) %}
                        <script>linkForKey['{{ letter }}'] = "{{ link }}";</script>
                        Carried by
                        <a href="{{ link }}">{{ container.name }}</a>
                        <span class="hotkey-indicator">[{{ letter }}]</span>
                        <br>
                    {% elif current.pile.container_type() == 'loc' %}
                        {% set link = url_for('play_location', loc_id=container.id) %}
                        {% set letter = link_letters.next(link) %}
                        <script>linkForKey['{{ letter }}'] = "{{ link }}";</script>
                        At
                        <a href="{{ link }}">{{ container.name }}</a>
                        {% if max(current.pile.position) %}
                            <span class="label-like">[{{ current.pile.position }}]</span>
                        {% endif %}
                        <span class="hotkey-indicator">[{{ letter }}]</span>
                        <br>
                    {% else %}
                        General Storage (by default)
                        <br>
                    {% endif %}
                    <h2 style="margin: 10px 10px;
                               display: flex;
                               align-items: center;
                               flex-wrap: nowrap">
                        {{ current.maskable_name() }}{% if not current.maskable_name().endswith(('.', 'â€¢', '!', '?', ',', ';', ':')) %}:{% endif %}&nbsp;
                        {% if current.q_limit %}
                            <div id="storage-progress-container"
                                 class="progress-container"
                                 style="display: inline-flex;
                                        align-items: center;
                                        margin-left: 10px;">
                                <progress id="storage-progress-bar" class="progress-bar" value="0" max="100"></progress>
                                <span class="progress-label"
                                      id="storage-progress-label"
                                      style="margin-left: 5px;
                                             color: white;
                                             font-weight: bold">...</span>
                            </div>
                        {% else %}
                            <span id="main-quantity">...</span>
                        {% endif %}
                    </h2>
                </td>
            </tr>
            <tr>
                <td>
                    <style>
                        .progress-bar.different-color::-webkit-progress-value {
                            background-color: blue;
                        }

                        .progress-bar.different-color::-moz-progress-bar {
                            background-color: blue;
                        }
                    </style>
                    <div id="action-progress-container"
                         style="width: 60%;"
                         class="progress-container hidden">
                        <progress id="action-progress-bar"
                            class="progress-bar different-color"
                            value="0"
                            max="100"></progress>
                        <span class="progress-label" id="action-progress-label">0%</span>
                    </div>
                </td>
            </tr>
            <tr>
                <style>
                .button-container {
                    display: flex;
                    flex-direction: row;
                    align-items: flex-start;
                    gap: 10px;
                }

                .button-column {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                }
                </style>
                <td>
                    <div class="button-container">
                        {% if current.pile.container_type() == 'char' %}
                            {% if current.pile.slot %}
                                <div class="button-column" id="unequip-container">
                                    <button id="unequip-btn" class="go-button">Une[q]uip</button>
                                    <span class="text-by-button">{{ current.pile.slot }}</span>
                                </div>
                            {% else %}
                                {% if game_data.overall.slots %}
                                    <div class="button-column" id="equip-container">
                                        <button id="equip-btn" class="go-button">E[q]uip</button>
                                        <select id="char-equip-slot">
                                            {% for slot in game_data.overall.slots %}
                                                <option value="{{ slot }}" {% if slot == defaults.slot %}selected{% endif %}>{{ slot }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                {% endif %}
                            {% endif %}
                            <div class="button-column" id="drop-container">
                                <button id="drop-btn" class="go-button">[D]rop</button>
                                <input type="text" id="quantity_to_drop" size="10" value="{{ current.pile.quantity | formatNum }}">
                            </div>
                        {% endif %}
                        {% if current.pile.container_type() == 'loc' and params.loc_id and characters_at_loc %}
                            <div class="button-column" id="pickup-container">
                                <button id="pickup-btn" class="go-button">[P]ick Up</button>
                                <select id="char-picking-up">
                                    {% for char in characters_at_loc %}
                                        <option value="{{ char.id }}"
                                                {% if char.id == defaults.pickup_char %}selected{% endif %}>
                                            {{ char.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% if current.masked %}
                <tr>
                    <td>
                        <p><b>This item is currently masked. To reveal, produce some of the sources, or uncheck "<i>Masked</i>" in item setup.</b></p>
                    </td>
                </tr>
            {% elif current.description %}
                <tr>
                    <td>
                        <p>{{ current.description|htmlify }}</p>
                    </td>
                </tr>
            {% endif %}
            {% if current.recipes %}
                <tr>
                    <td>
                        <style>
                    .nested-table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    .nested-table td {
                        height: 25px;
                        vertical-align: middle;
                        /* border: 1px solid #888; */
                    }
                        </style>
                        <table class="inner-table spacious"
                               cellspacing="0"
                               cellpadding="5"
                               style="width: 100%">
                            <tr>
                                <th>Batches</th>
                                <th>Rate</th>
                                <th></th>
                                <th>Source</th>
                                <th>Required</th>
                                <th>In Stock</th>
                                <th title="If there is a page that should be shown in this column, first navigate to that page.">Where</th>
                            </tr>
                            {% for recipe in current.recipes|sort(attribute='id') %}
                                {% if not loop.first %}<tr style="border-top: 1px solid #888;"></tr>{% endif %}
                                {% set attribs_list = recipe.attrib_reqs.values() | list %}
                                {% set max_rows = max(recipe.byproducts|length + 1, recipe.sources|length + attribs_list|length) %}
                                {% set recipescope = namespace(main_items_consumed=0) %}
                                {% for source in recipe.sources %}
                                    {% if source.item.id == current.id and not source.preserve %}
                                        {% set recipescope.main_items_consumed = source.q_required %}
                                    {% endif %}
                                {% endfor %}
                                {% for row in range(0, max_rows) %}
                                    {% set byproduct_index = row - 1 %}{# subtract 1 for gain button row #}
                                    {% set attrib_index = row - recipe.sources|length %}
                                    {% if loop.first %}
                                        <tr>
                                            <td style="vertical-align: top;">
                                                {% if current.progress.can_produce(recipe.id) %}
                                                {% set letter = link_letters.next() %}
                                                {% if recipe.instant %}
                                                    <input type="text"
                                                           class="quantity_to_gain"
                                                           id="quantity_to_gain_{{ recipe.id }}"
                                                           size="3"
                                                           value="{{ max_batches.get(recipe.id, 1) }}">
                                                    <div style="white-space: nowrap;">
                                                        [{{ letter }}]
                                                        <button type="button"
                                                                data-recipe-id="{{ recipe.id }}"
                                                                data-rate-amount="{{ recipe.rate_amount }}"
                                                                class="gain-btn go-button"
                                                                id="gain-btn_{{ recipe.id }}">Gain</button>
                                                    </div>
                                                    <script>
                                                    funcForKey['{{ letter }}'] = () => {
                                                        document.querySelector('#gain-btn_{{ recipe.id }}').click();
                                                    };
                                                    </script>
                                                {% else %}
                                                    [{{ letter }}]
                                                    <button type="button"
                                                            class="start-stop-btn go-button"
                                                            id="start-stop-btn_{{ recipe.id }}"
                                                            data-recipe-id="{{ recipe.id }}">Start</button>
                                                    <script>
                                                    funcForKey['{{ letter }}'] = () => {
                                                        document.querySelector('#start-stop-btn_{{ recipe.id }}').click();
                                                    };
                                                    </script>
                                                {% endif %}
                                                {% else %}
                                                    <span style="font-size: 1em"
                                                          title=" {{ current.progress.failure_reason }}">ðŸš«</span>
                                                {% endif %}
                                            </td>
                                            <td style="vertical-align: top; padding-top: 12px;">
                                                <span class="rate-amount" id="rate-amount_{{ recipe.id }}">
                                                    {% if recipescope.main_items_consumed > 0
                                                            and recipe.rate_amount >= 0
                                                            and recipe.rate_amount <= recipescope.main_items_consumed %}
                                                        <span style="vertical-align: middle; font-size: 2em"
                                                              title="(trash can icon) does not produce the current item">ðŸ—‘</span>
                                                    {% else %}
                                                        {{ recipe.rate_amount | formatNum }}
                                                    {% endif %}
                                                </span>
                                                {% if not recipe.instant %}
                                                    {% if recipe.rate_amount %}per{% endif %}
                                                    <span class="rate-duration"
                                                            id="rate-duration_{{ recipe.id }}"
                                                            data-duration="{{ recipe.rate_duration }}"
                                                            >{{ recipe.rate_duration | formatNum }}</span>s
                                                {% endif %}
                                            </td>
                                        {% elif byproduct_index < recipe.byproducts|length %}
                                            {% set byproduct = recipe.byproducts[byproduct_index] %}
                                            {% set item = byproduct.item %}
                                            <tr>
                                                {% set pos = current.pile.position if current.pile else "" %}
                                                {% set link = url_for('play_item', item_id=item.id, char_id=params.char_id, loc_id=params.loc_id, pos=pos) %}
                                                {% set letter = link_letters.next(link) %}
                                                <script>linkForKey['{{ letter }}'] = "{{ link|safe }}";</script>
                                                <td>
                                                    <strong title="byproduct">&amp;</strong>
                                                    <span class="hotkey-indicator">[{{ letter }}]</span>
                                                    <a href="{{ link }}">{{ item.maskable_name() }}</a>
                                                </td>
                                                <td>{{ byproduct.rate_amount | formatNum }}</td>
                                            {% else %}
                                                <!-- add empty columns to even out the sides, starting the row -->
                                                <tr>
                                                    <td colspan=2></td>
                                                {% endif %}
                                                {% if loop.first %}
                                                    <td rowspan="{{ max_rows }}" style="position: relative">
                                                        <div style="position: absolute;
                                                                    top: 12.5%;
                                                                    right: 0;
                                                                    width: 0;
                                                                    height: 75%;
                                                                    border-right: 1px dotted #888"></div>
                                                    </td>
                                                {% endif %}
                                                {% if row < recipe.sources|length %}
                                                    {% set source = recipe.sources[row] %}
                                                    {% set item = source.item %}
                                                    {% if item.id == current.id or (item.storage_type == 'local' and not params.loc_id) %}
                                                        <td>
                                                            <strong>{{ item.maskable_name() }}</strong>
                                                        </td>
                                                    {% else %}
                                                        {% set pos = source.pile.position if source.pile else "" %}
                                                        {% set link = url_for('play_item', item_id=item.id, char_id=params.char_id, loc_id=params.loc_id, pos=pos) %}
                                                        {% set letter = link_letters.next(link) %}
                                                        <script>linkForKey['{{ letter }}'] = "{{ link|safe }}";</script>
                                                        <td>
                                                            <span class="hotkey-indicator">[{{ letter }}]</span>
                                                            <a href="{{ link }}">{{ item.maskable_name() }}</a>
                                                        </td>
                                                    {% endif %}
                                                    <td>
                                                        {% if source.preserve %}
                                                            ({{ source.q_required | formatNum }})
                                                        {% else %}
                                                            {{ source.q_required | formatNum }}
                                                        {% endif %}
                                                    </td>
                                                    <td class="source-{{ item.id }}-quantity">
                                                        {% if source.pile %}
                                                            {{ source.pile.quantity | formatNum }}
                                                        {% else %}
                                                            <div style="text-align: center">â€”</div>
                                                        {% endif %}
                                                    </td>
                                                    <td id="recipe-{{ recipe.id }}-source-{{ item.id }}-at">
                                                        {% if source.pile and source.pile.quantity > 0 %}
                                                            {% set container = source.pile.container %}
                                                            {% if source.pile.container_type() == 'general' %}
                                                                (General)
                                                            {% else %}
                                                                {% if source.pile.container_type() == 'char' %}
                                                                    {% set link = url_for('play_char', char_id=container.id) %}
                                                                {% elif source.pile.container_type() == 'loc' %}
                                                                    {% set link = url_for('play_location', loc_id=container.id) %}
                                                                {% else %}
                                                                    {% set link = "/unexpected-pile-type" %}
                                                                {% endif %}
                                                                {% set letter = link_letters.next(link) %}
                                                                <script>linkForKey['{{ letter }}'] = "{{ link }}";</script>
                                                                <span class="hotkey-indicator">[{{ letter }}]</span>
                                                                <a href="{{ link }}">{{ container.name }}</a>
                                                                <br>
                                                            {% endif %}
                                                        {% else %}
                                                            <div style="text-align: center">â€”</div>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% elif attrib_index < attribs_list|length %}
                                                {% set req = attribs_list[attrib_index] %}
                                                <td>{{ req.attrib.name }}</td>
                                                <td>
                                                    {% if req.attrib.enum %}
                                                        {{ req.enum_range_str() }}
                                                    {% elif req.attrib.binary %}
                                                        {{ ('&check;' if (req.min_str() | int) == 1 else 'X') | safe }}
                                                    {% else %}
                                                        {{ req.range_str() }}
                                                    {% endif %}
                                                </td>
                                                {% if req.subject %}
                                                    {% set subject = req.subject %}
                                                    <td>
                                                        {% set attrib_val = subject.attribs[req.attrib.id].val %}
                                                        {% if req.attrib.enum %}
                                                            {{ req.attrib.enum[attrib_val | int] }}
                                                        {% elif req.attrib.binary %}
                                                            {{ ('&check;' if attrib_val else 'X') | safe }}
                                                        {% else %}
                                                            {{ attrib_val | formatNum }}
                                                        {% endif %}
                                                    </td>
                                                    {% if subject.__class__.__name__ == 'Character' %}
                                                        {% set link = url_for('play_char', char_id=subject.id) %}
                                                    {% elif subject.__class__.__name__ == 'Item' %}
                                                        {% set link = url_for('play_item', item_id=subject.id) %}
                                                    {% else %}
                                                        {% set link = "/unexpected-subject-type" %}
                                                    {% endif %}
                                                    {% set letter = link_letters.next(link) %}
                                                    <script>linkForKey['{{ letter }}'] = "{{ link }}";</script>
                                                    <td>
                                                        <span class="hotkey-indicator">[{{ letter }}]</span>
                                                        <a href="{{ link }}">{{ subject.name }}</a>
                                                    </td>
                                                {% else %}
                                                    <td>&mdash;</td>
                                                    <td>(Not Found)</td>
                                                {% endif %}
                                            </tr>
                                        {% else %}
                                            <!-- add empty columns to even out the sides, finishing the row -->
                                            <td colspan=4></td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </table>
                    </td>
                </tr>
            {% endif %}
            {% set outerscope = namespace(used_as_source=[], produced_as_byproduct=[]) %}
            {% for other_item in game_data.items if other_item.id != current.id %}{# e.g. pigs breeding pigs #}
                {% for recipe in other_item.recipes %}
                    {% for source in recipe.sources %}
                        {% if current.id == source.item.id %}
                            {% set _ = outerscope.used_as_source.append(
                                {'item': other_item, 'source': source}) %}
                        {% endif %}
                    {% endfor %}
                    {% for byproduct in recipe.byproducts %}
                        {% if current.id == byproduct.item.id %}
                            {% set _ = outerscope.produced_as_byproduct.append(
                                {'item': other_item, 'rate_amount': byproduct.rate_amount}) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
            {% if outerscope.used_as_source %}
                <tr>
                    <td>
                        <table class="inner-table spacious" cellspacing="0" cellpadding="5">
                            <tr>
                                <th>Used For</th>
                                <th>Required</th>
                            </tr>
                            {% for used_for in outerscope.used_as_source %}
                                {% set source = used_for.source %}
                                {% if used_for.item.storage_type == 'local' and not params.loc_id %}
                                    <tr>
                                        <td>
                                            <strong>{{ used_for.item.maskable_name() }}</strong>
                                        </td>
                                        <td>
                                            {% if source.preserve %}
                                                ({{ source.q_required | formatNum }})
                                            {% else %}
                                                {{ source.q_required | formatNum }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% else %}
                                    {% set link = url_for('play_item', item_id=used_for.item.id, char_id=params.char_id, loc_id=params.loc_id) %}
                                    {% set letter = link_letters.next(link) %}
                                    <script>linkForKey['{{ letter }}'] = "{{ link|safe }}";</script>
                                    <tr>
                                        <td>
                                            <span class="hotkey-indicator">[{{ letter }}]</span>
                                            <a href="{{ link }}">{{ used_for.item.maskable_name() }}</a>
                                        </td>
                                        <td>
                                            {% if source.preserve %}
                                                ({{ source.q_required | formatNum }})
                                            {% else %}
                                                {{ source.q_required | formatNum }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </table>
                    </td>
                </tr>
            {% endif %}
            {% if outerscope.produced_as_byproduct %}
                <tr>
                    <td>
                        <table class="inner-table spacious" cellspacing="0" cellpadding="5">
                            <tr>
                                <th>Byproduct of a Recipe for</th>
                            </tr>
                            {% for byproduct_of in outerscope.produced_as_byproduct %}
                                {% set link = url_for('play_item', item_id=byproduct_of.item.id, char_id=params.char_id, loc_id=params.loc_id) %}
                                {% set letter = link_letters.next(link) %}
                                <script>linkForKey['{{ letter }}'] = "{{ link|safe }}";</script>
                                <tr>
                                    <td>
                                        <span class="hotkey-indicator">[{{ letter }}]</span>
                                        <a href="{{ link }}">{{ byproduct_of.item.maskable_name() }}</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    </td>
                </tr>
            {% endif %}
            {% if current.attribs %}
                <tr>
                    <td>
                        <h2>Attributes</h2>
                        <ul>
                            {% for attrib_of in current.attribs.values() %}
                                {% set link = url_for('play_attrib', attrib_id=attrib_of.attrib_id, subject_type='item', subject_id=current.id) %}
                                {% set letter = link_letters.next(link) %}
                                <script>linkForKey['{{ letter }}'] = "{{ link|safe }}";</script>
                                <li>
                                    <span class="hotkey-indicator">[{{ letter }}]</span>
                                    <a href="{{ link }}">{{ attrib_of.attrib.name }}</a>
                                    {% if attrib_of.attrib.enum %}
                                        {% set index = attrib_of.val | int %}
                                        {% if index in range(attrib_of.attrib.enum | length) %}
                                            {{ attrib_of.attrib.enum[index] }}
                                        {% else %}
                                            ?
                                        {% endif %}
                                    {% elif attrib_of.attrib.binary %}
                                        {{ ('&check;' if attrib_of.val else 'X') | safe }}
                                    {% else %}
                                        {{ attrib_of.val | formatNum }}
                                    {% endif %}
                                </li>
                            {% else %}
                                (None)
                                <br>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
            {% endif %}
            {% if game_data.events %}
                <tr>
                    <td>
                        <table class="inner-table spacious" cellspacing="0" cellpadding="5">
                        <h2>Item Events</h2>
                        <ul>
                            {% for evt in game_data.events %}
                                {% set link = url_for('play_event', event_id=evt.id, from_id=current.id, from_typename=current.typename()) %}
                                {% set letter = link_letters.next(link) %}
                                <script>linkForKey['{{ letter }}'] = "{{ link }}";</script>
                                <span class="hotkey-indicator">[{{ letter }}]</span>
                                <a href="{{ link }}">{{ evt.name }}</a>
                                {% if evt.trigger_chance > 0 %}
                                    <span class="label-like">&nbsp;(chance to trigger)</span>
                                {% endif %}
                                <br>
                            {% else %}
                                <p>(None)</p>
                            {% endfor %}
                        </ul>
                        </table>
                    </td>
                </tr>
            {% endif %}
        </table>
        {% include 'play/custom_confirm.html' %}
        <script>
        $(document).ready(() => {
            function getItemProgressUrl(itemId, mainPileType='') {
                const queryParams = [];
                const charId = "{{ params.char_id }}";
                if (charId) {
                    queryParams.push(`char_id=${encodeURIComponent(charId)}`);
                }
                const locId = "{{ params.loc_id }}";
                if (locId) {
                    queryParams.push(`loc_id=${encodeURIComponent(locId)}`);
                }
                const pos = "{{ container.position if container.typename() == 'char' else current.pile.position }}";
                if (pos) {
                    queryParams.push(`pos=${encodeURIComponent(pos)}`);
                }
                if (mainPileType) {
                    queryParams.push(`main=${encodeURIComponent(mainPileType)}`);
                }
                const ignoreEventId = localStorage.getItem('ignore_event_id') || '';
                if (ignoreEventId) {
                    queryParams.push(`ignore_event=${encodeURIComponent(ignoreEventId)}`);
                }
                let url = `/item/progress/${itemId}`;
                if (queryParams.length > 0) {
                    url += `?${queryParams.join('&')}`;
                }
                return url;
            }

            // Global variable to store the elapsed time.
            let serverElapsedTime = 0;
            let clientElapsedTime = 0;
            let rateDuration = 1;
            let in_progress = false;

            // Fetch progress data and update all relevant information
            async function fetchProgressData() {
                const url = getItemProgressUrl({{ current.id }}, "{{ params.main_pile_type }}")
                const combined_data = await new Promise((resolve, reject) => {
                    $.get(url, (response) => {
                        resolve(response);
                    }).fail((jqXHR, textStatus, error) => {
                        reject(error);
                    });
                });
                data = combined_data;
                if ('status' in data && data.status === 'interrupt') {
                    handleInterrupt(data);
                    return;
                }
                if (data.unmasked_items) {
                    location.reload();
                    return;
                }
                data = combined_data.main;
                clientElapsedTime = 0;
                serverElapsedTime = data.elapsed_time || 0;
                rateDuration = parseFloat($(`#rate-duration_${data.recipe_id}`).data('duration')) || 1;
                if (in_progress && !data.is_ongoing) {
                    localStorage.removeItem('ignore_event_id');
                }
                in_progress = data.is_ongoing;
                updateQuantities(combined_data);
                updateStartButtonLabel(data, data.recipe_id);
                updateProgressVisibility();
                updateVisibility(data.quantity);
            }
            function updateQuantities(combined_data) {
                const main = combined_data.main
                const sources = combined_data.sources
                console.log('updateQuantities()', main.quantity_str);
                const quantityText = main.quantity_str;
                const qLimit = {{ current.q_limit }};
                const qLimitText = "{{ current.q_limit | formatNum }}";
                {% if current.q_limit %}
                    updateStorageProgress(main.quantity, quantityText, qLimit, qLimitText);
                {% else %}
                    $('#main-quantity').text(quantityText);
                {% endif %}
                sources.forEach((source) => {
                    $(`.source-${source.id}-quantity`).text(source.quantity);
                });
            }

            function updateStorageProgress(quantity, qtyText, maxQuantity, maxQtyText) {
                if (maxQuantity === 0) {
                    // There shouldn't be any bar
                    return;
                }
                const progressBar = $('#storage-progress-bar');
                const progressLabel = $('#storage-progress-label');
                const progressPercent = (quantity / maxQuantity) * 100;
                progressBar.attr('max', 100);
                progressBar.attr('value', progressPercent);
                progressLabel.text(`${qtyText} / ${maxQtyText}`);
            }

            let maxEffective = 0;
            function effectiveElapsedTime() {
                if (serverElapsedTime % rateDuration + clientElapsedTime > rateDuration) {
                    return rateDuration;
                } else {
                    const elapsedTime = serverElapsedTime + clientElapsedTime;
                    return elapsedTime % rateDuration;
                }
            }
            function updateActionProgress() {
                const progressBar = $('#action-progress-bar');
                const progressLabel = $('#action-progress-label');
                const elapsedTime = effectiveElapsedTime();
                if (elapsedTime + 1 < maxEffective) {
                    localStorage.removeItem('ignore_event_id');
                }
                maxEffective = elapsedTime;
                const progressPercent = (elapsedTime / rateDuration) * 100;
                progressBar.val(progressPercent);
                progressLabel.text(`${Math.floor(elapsedTime)} / ${rateDuration} sec`);
            }
            function updateElapsedTime() {
                updateActionProgress();
                if (in_progress) {
                    clientElapsedTime += 0.02;
                }
            }

            // the Start button can change to "Stop"
            function updateStartButtonLabel(data, recipe_id) {
                $(".start-stop-btn").each(function() {
                    const btnRecipeId = $(this).data("recipe-id");
                    if (btnRecipeId && parseInt(btnRecipeId) === recipe_id) {
                        if (data && data.is_ongoing) {
                            $(this).html("Stop")
                                   .addClass("dangerous-button")
                                   .removeClass("go-button");
                        } else {
                            $(this).html("Start")
                                   .addClass("go-button")
                                   .removeClass("dangerous-button");
                        }
                    }
                });
            }

            function updateProgressVisibility() {
                if (!in_progress) {
                    $('#action-progress-container').addClass('hidden');
                    return;
                }
                if (rateDuration < 3) {
                    $('#action-progress-container').addClass('hidden');
                } else {
                    $('#action-progress-container').removeClass('hidden');
                }
            }

            let intervalIds = [];
            function startFetchingProgress() {
                if (intervalIds.length !== 0) {
                    stopFetchingProgress();
                }
                intervalIds = [
                    setInterval(fetchProgressData, 1000), 
                    setInterval(updateElapsedTime, 20)
                ];
            }
            function stopFetchingProgress() {
                intervalIds.forEach(clearInterval);
                intervalIds = [];
            }

            function showContent() {
                $('#content').css('display', 'block');
            }
            async function initializePage() {
                try {
                    await fetchProgressData();
                    startFetchingProgress();
                    updateElapsedTime();
                } catch (error) {
                    console.error("Error fetching progress data:", error);
                }
                showContent();
            }
            initializePage();

            $('.gain-btn').click((event) => {
                const quantityInput = $(event.currentTarget).prev('.quantity_to_gain');
                const quantity = parseInt(quantityInput.val(), 10);
                const recipe_id = $(event.currentTarget).data('recipe-id');
                if (isNaN(quantity) || Number(quantity) === 0) {
                    alert('Please enter a valid number for the quantity.');
                    return;
                }
                const item_id = {{ current.id }}
                stopFetchingProgress();
                $.ajax({
                    url: `/item/gain/${item_id}/${recipe_id}`,
                    method: 'post',
                    data: { quantity: quantity },
                    success: (response) => {
                        if (response.status === 'error') {
                            console.error(response.message);
                            alert(response.message);
                        }
                    },
                    error: (error) => {
                        console.error('Error:', error);
                        alert(`Error: ${error}`);
                    },
                    complete: () => {
                        fetchProgressData();
                        startFetchingProgress();
                    }
                });
            });
            $('.start-stop-btn').click((event) => {
                const current_id = {{ current.id }};
                const startBtn = event.currentTarget;
                const recipe_id = $(event.currentTarget).data('recipe-id');
                console.log(`start/stop button clicked for recipe ${recipe_id}`);
                const urlParts = ['/item/stop', current_id];
                if (startBtn.innerHTML === "Start") {
                    urlParts[0] = '/item/start';
                    urlParts.push(recipe_id);
                }
                const url = urlParts.join('/');
                console.log(`url ${url}`);
                stopFetchingProgress();
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        if (data.status === 'error') {
                            console.error('Could not start or stop:', data.message);
                            alert(data.message);
                        }
                        updateStartButtonLabel(data, recipe_id);
                        fetchProgressData();
                        startFetchingProgress();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        startFetchingProgress();
                    });
            });
            $('#drop-btn').click(() => {
                const itemId = "{{ current.id }}";
                const charId = "{{ container.id }}";
                const quantity = $('#quantity_to_drop').val();
                $.ajax({
                    url: `/item/drop/${itemId}/char/${charId}/qty/${quantity}`,
                    method: 'post',
                    success: (response) => {
                        if (response.status === 'success') {
                            const url = "{{ url_for('play_char', char_id=container.id) }}";
                            window.location.href = url;
                        } else {
                            console.error(response.message);
                            alert(`Error: ${response.message}`);
                        }
                    },
                    error: (error) => {
                        console.error('Error:', error);
                        alert(`Error: ${error}`);
                    }
                });
            });
            $('#pickup-btn').click(() => {
                const itemId = "{{ current.id }}";
                const locId = "{{ container.id }}";
                let pos = "{{ current.pile.position }}";
                if (pos === "") {
                    pos = encodeURIComponent(" ");
                }
                const charId = $('#char-picking-up').val();
                if (!charId) {
                    alert('Please select a character to pick up the item.');
                    return;
                }
                $.ajax({
                    url: `/item/pickup/${itemId}/loc/${locId}/pos/${pos}/char/${charId}`,
                    method: 'post',
                    success: (response) => {
                        if (response.status === 'success') {
                            const url = "{{ url_for('play_location', loc_id=container.id) }}";
                            window.location.href = url;
                        } else {
                            console.error(response.message);
                            alert(`Error: ${response.message}`);
                        }
                    },
                    error: (error) => {
                        console.error('Error:', error);
                        alert(`Error: ${error}`);
                    }
                });
            });
            $('#equip-btn').click(() => {
                const itemId = "{{ current.id }}";
                const charId = "{{ container.id }}";
                const slot = $('#char-equip-slot').val();
                if (!slot) {
                    alert('Please select a slot to equip the item.');
                    return;
                }
                $.ajax({
                    url: `/item/equip/${itemId}/char/${charId}/slot/${slot}`,
                    method: 'post',
                    success: (response) => {
                        if (response.status === 'success') {
                            const url = "{{ url_for('play_char', char_id=container.id) }}";
                            window.location.href = url;
                        } else {
                            console.error(response.message);
                            alert(`Error: ${response.message}`);
                        }
                    },
                    error: (error) => {
                        console.error('Error:', error);
                        alert(`Error: ${error}`);
                    }
                });
            });
            $('#unequip-btn').click(() => {
                const itemId = "{{ current.id }}";
                const charId = "{{ container.id }}";
                $.ajax({
                    url: `/item/unequip/${itemId}/char/${charId}`,
                    method: 'post',
                    success: (response) => {
                        if (response.status === 'success') {
                            window.location.href = "{{ url_for('play_char', char_id=container.id) }}";
                        } else {
                            console.error(response.message);
                            alert(`Error: ${response.message}`);
                        }
                    },
                    error: (error) => {
                        console.error('Error:', error);
                        alert(`Error: ${error}`);
                    }
                });
            });

            async function updateVisibility(mainQuantity) {
                const notEmpty = mainQuantity !== 0;
                const storage_carried = '{{ current.storage_type }}' === 'carried';
                const storage_local = '{{ current.storage_type }}' === 'local';
                const atLoc = '{{ current.pile.container_type() }}' === 'loc';
                const inventory = '{{ current.pile.container_type() }}' === 'char';
                const charAtLoc = {{ container.location is not none | lower }};
                const inSlot = '{{ current.pile.slot }}' !== '';
                const visibilityMap = {
                    'equip-container': notEmpty && inventory && storage_carried && !inSlot,
                    'pickup-container': notEmpty && atLoc && !storage_local,
                    'unequip-container': notEmpty && inSlot,
                    'drop-container': notEmpty && inventory && charAtLoc && !inSlot,
                };
                Object.keys(visibilityMap).forEach((id) => {
                    if (visibilityMap[id]) {
                        $(`#${id}`).show();
                    } else {
                        $(`#${id}`).hide();
                    }
                });
            }

            async function handleInterrupt(data) {
                console.log("handleInterrupt()");
                stopFetchingProgress();
                $(".start-stop-btn").each(function() {
                    if ($(this).html() === "Stop") {
                        $(this).click();
                    }
                });
                await showCustomConfirm(data.message);
                localStorage.setItem('ignore_event_id', data.event_id);
                const baseEventUrl = "{{ url_for('play_event', event_id=MAX_INT_32, from_id=current.id, from_typename=current.typename()) | safe }}"
                const url = baseEventUrl.replace('{{ MAX_INT_32 }}', data.event_id);
                console.log("Confirmed to go to ", url);
                window.location.href = url;
            }
        });
        </script>
    </div>
    <!-- content -->
{% endblock %}
